# app/core/malware.py
import joblib
import numpy as np
from app.core.config import get_settings

settings = get_settings()
MODEL_PATH = settings.MODEL_PATH

try:
    model = joblib.load(MODEL_PATH)
    # model may be sklearn-like or LGBMClassifier saved via joblib
    print("ML model loaded:", MODEL_PATH)
except Exception as e:
    raise RuntimeError(f"Failed to load ML model: {e}")

def predict_malware(features: list) -> float:
    """
    Return malware probability between 0 and 1.
    Supports sklearn-like models with predict_proba, otherwise uses predict().
    """
    X = np.array(features, dtype=float).reshape(1, -1)
    if hasattr(model, "predict_proba"):
        proba = model.predict_proba(X)[0][1]
        return float(proba)
    else:
        # fallback: model.predict returns 0/1 or score
        out = model.predict(X)
        try:
            return float(out[0])
        except Exception:
            return float(out)
