# app/core/malware.py

import joblib
import pandas as pd
import numpy as np
from pathlib import Path
from app.core.config import get_settings
from app.core.ember_extractor import PEFeatureExtractor
import lief

# Load settings
settings = get_settings()
MODEL_PATH = Path(settings.MODEL_PATH)

# Load pre-trained ML model
try:
    model = joblib.load(MODEL_PATH)
    print("ML model loaded:", MODEL_PATH)
except Exception as e:
    raise RuntimeError(f"Failed to load ML model: {e}")

# Initialize EMBER PE feature extractor
extractor = PEFeatureExtractor(feature_version=2)
print("EMBER feature extractor initialized.")

def extract_features(file_path: str) -> np.ndarray:
    """
    Extract feature vector from a PE file using EMBER extractor.
    Returns a numpy array of features.
    """
    with open(file_path, "rb") as f:
        bytez = f.read()

    # LIEF exception handling for modern versions
    lief_errors = (
        lief.bad_format, lief.bad_file, lief.pe_error, lief.parser_error,
        lief.read_out_of_bound, RuntimeError
    )

    try:
        features_vector = extractor.feature_vector(bytez)
        return features_vector
    except lief_errors as e:
        print(f"Error extracting features from {file_path}: {e}")
        return np.zeros(extractor.dim, dtype=np.float32)
    except Exception as e:
        print(f"Unexpected error extracting features from {file_path}: {e}")
        return np.zeros(extractor.dim, dtype=np.float32)

def predict_malware(features: np.ndarray) -> float:
    """
    Return malware probability between 0 and 1 using pre-trained model.

    Args:
        features: np.ndarray of shape (n_features,) extracted using EMBER

    Returns:
        float: malware probability
    """
    features = np.array(features).reshape(1, -1)

    # Ensure features match model column expectations
    col_names = [f"f{i}" for i in range(features.shape[1])]
    X = pd.DataFrame(features, columns=col_names)

    try:
        if hasattr(model, "predict_proba"):
            proba = model.predict_proba(X)[0][1]
            return float(proba)
        else:
            return float(model.predict(X)[0])
    except Exception as e:
        print(f"Prediction error: {e}")
        return 0.0  # fallback to safe default
